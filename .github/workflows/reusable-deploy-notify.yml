name: Reusable Deploy Notify

on:
  workflow_call:
    inputs:
      project-name:
        required: true
        type: string
      should-deploy:
        required: true
        type: string
      new-tag:
        required: true
        type: string
      is-success:
        required: true
        type: string
      statuses-text:
        required: true
        type: string
    secrets:
      TELEGRAM_CHAT_ID:
        required: false
      TELEGRAM_BOT_TOKEN:
        required: false
      DISCORD_WEBHOOK:
        required: false

jobs:
  notify:
    if: ${{ inputs.should-deploy == 'true' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        channel: [telegram, discord]

    env:
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}

      REPO: ${{ github.repository }}
      REPO_URL: https://github.com/${{ github.repository }}
      COMMIT_SHA: ${{ github.sha }}
      COMMIT_URL: https://github.com/${{ github.repository }}/commit/${{ github.sha }}
      ACTOR: ${{ github.actor }}
      ACTOR_URL: https://github.com/${{ github.actor }}
      RUN_URL: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}

      # =======================
      # SUCCESS MESSAGE (Markdown)
      # =======================
      SUCCESS_MESSAGE: |
        ðŸš€ **${{ inputs.project-name }}**

        âœ… **Deploy succeeded**

        ${{ inputs.new-tag != '' && format('Tag [{0}](https://github.com/{1}/releases/tag/{0})', inputs.new-tag, github.repository) || 'Tag: *(not specified)*' }}

        â€¢ Repository: [${{ env.REPO }}](${{ env.REPO_URL }})
        â€¢ Commit: [${{ env.COMMIT_SHA }}](${{ env.COMMIT_URL }})
        â€¢ Actor: [${{ env.ACTOR }}](${{ env.ACTOR_URL }})

        ðŸ‘‰ [View run](${{ env.RUN_URL }})

      # =======================
      # FAILURE MESSAGE (Markdown)
      # =======================
      FAILURE_MESSAGE: |
        ðŸš¨ **${{ inputs.project-name }}**

        âŒ **Build/Deploy failed**

        â€¢ Repository: [${{ env.REPO }}](${{ env.REPO_URL }})
        â€¢ Workflow: `${{ github.workflow }}`
        â€¢ Event: `${{ github.event_name }}`
        â€¢ Commit: [${{ env.COMMIT_SHA }}](${{ env.COMMIT_URL }})
        â€¢ Actor: [${{ env.ACTOR }}](${{ env.ACTOR_URL }})

        **Job statuses:**
        ${{ inputs.statuses-text }}

        ðŸ‘‰ [View run](${{ env.RUN_URL }})

    steps:
      # =======================
      # Telegram
      # =======================
      - name: Telegram | Success
        if: >-
          matrix.channel == 'telegram' &&
          inputs.is-success == 'true' &&
          env.TELEGRAM_BOT_TOKEN != '' &&
          env.TELEGRAM_CHAT_ID != ''
        uses: appleboy/telegram-action@master
        with:
          to: ${{ env.TELEGRAM_CHAT_ID }}
          token: ${{ env.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: ${{ env.SUCCESS_MESSAGE }}

      - name: Telegram | Failure
        if: >-
          matrix.channel == 'telegram' &&
          inputs.is-success != 'true' &&
          env.TELEGRAM_BOT_TOKEN != '' &&
          env.TELEGRAM_CHAT_ID != ''
        uses: appleboy/telegram-action@master
        with:
          to: ${{ env.TELEGRAM_CHAT_ID }}
          token: ${{ env.TELEGRAM_BOT_TOKEN }}
          format: markdown
          message: ${{ env.FAILURE_MESSAGE }}

      # =======================
      # Discord
      # =======================
      - name: Discord | Success
        if: >-
          matrix.channel == 'discord' &&
          inputs.is-success == 'true' &&
          env.DISCORD_WEBHOOK != ''
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ env.DISCORD_WEBHOOK }}
          status: success
          nodetail: true
          title: >-
            Production deployment${{ inputs.new-tag != '' && format(' ({0})', inputs.new-tag) || '' }}
          description: ${{ env.SUCCESS_MESSAGE }}

      - name: Discord | Failure
        if: >-
          matrix.channel == 'discord' &&
          inputs.is-success != 'true' &&
          env.DISCORD_WEBHOOK != ''
        uses: sarisia/actions-status-discord@v1
        with:
          webhook: ${{ env.DISCORD_WEBHOOK }}
          status: failure
          nodetail: true
          title: >-
            Production deployment${{ inputs.new-tag != '' && format(' ({0})', inputs.new-tag) || '' }}
          description: ${{ env.FAILURE_MESSAGE }}